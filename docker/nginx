user root;
worker_processes auto;

events {
  worker_connections 64;
  multi_accept on;
  use epoll;
}

http {
  sendfile   on;
  tcp_nopush on;

	include      /etc/nginx/mime.types;
	default_type application/octet-stream;

  access_log /var/log/nginx/access.log;
  error_log  /var/log/nginx/error.log;

  index          /index.html;
  error_page 404 /index.html;

	gzip            on;
	gzip_types      text/plain text/css text/javascript applications/javascript application/x-javascript application/json;
	gzip_disable    "msie6";
	gzip_proxied    any;
	gzip_comp_level 5;
	gzip_buffers    16 8k;
	gzip_min_length 256;

  ssl_certificate     /etc/letsencrypt/live/x1z53.ru/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/x1z53.ru/privkey.pem;

  add_header Access-Control-Allow-Origin   '*';
  add_header Access-Control-Allow-Methods  'GET, POST, OPTIONS';
  add_header Access-Control-Allow-Headers  'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
  add_header Access-Control-Expose-Headers 'Content-Length,Content-Range';

  server {
		listen      80;
		listen      443 ssl;
		server_name x1z53.ru;

  	location /_next/static/ {
			alias      /root/main/.next/static/;
			expires    365d;
			access_log off;
  	}

  	location / {
			proxy_pass         http://localhost:3000;
			proxy_http_version 1.1;
			proxy_set_header   Upgrade $http_upgrade;
			proxy_set_header   Connection 'upgrade';
			proxy_set_header   Host $host;
			proxy_cache_bypass $http_upgrade;
  	}
  }

  server {
		listen      80;
		listen      443 ssl;
		server_name test.x1z53.ru;

  	location /_next/static/ {
			alias      /root/main/.next/static/;
			expires    365d;
			access_log off;
  	}

  	location / {
			proxy_pass         http://localhost:3001;
			proxy_http_version 1.1;
			proxy_set_header   Upgrade $http_upgrade;
			proxy_set_header   Connection 'upgrade';
			proxy_set_header   Host $host;
			proxy_cache_bypass $http_upgrade;
  	}
  }
}
